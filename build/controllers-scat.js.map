{"version":3,"sources":["controllers-scat.js"],"names":["r","e","n","t","o","i","f","c","require","u","a","Error","code","p","exports","call","length","1","module","InsuranceIinController","backend","$q","updateAvailable","vm","availableByPassengers","orderInfo","passengers","map","passenger","passengerNum","service","itemsByPassengers","nationalityCode","documentNumberDiscount","checkAdult","hasAdultKzWithIin","insuranceAvailable","hasAdultKz","hasInternationalFlights","some","plainFlights","flight","destinationCity","getCityByCode","destinationcity","originCity","origincity","countryEn","age","moment","sessionParams","todayDate","diff","dateOfBirth","switchService","locked","active","items","modifyExtraService","getInsuranceSubmitParams","removeExtraService","onlineMode","switchServiceItem","itemNum","selected","id","saveIinHandlers","then","race","filter","handler","num","getInsuranceFullPrice","item","value","price","Big","insurance_premium","plus","luggage_premium","toFixed","currency","passenger_id","params","ins","tins","productCode","this","getOrderInfo","angular","component","templateUrl","controller","controllerAs","bindings","hasOtherServices","2","alert","3","./components/es-insurance-with-iin/es-insurance-with-iin","./components/es-insurance/es-insurance"],"mappings":"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","file":"controllers-scat.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){\n\"use strict\";\nangular.module('app').component('esInsuranceIin', {\n    templateUrl: 'components/es-insurance-with-iin/es-insurance-with-iin.html',\n    controller: ['backend', '$q', InsuranceIinController],\n    controllerAs: 'vm',\n    bindings: {\n        service: '=service',\n        locked: '=locked',\n        hasOtherServices: '='\n    }\n});\n\nfunction InsuranceIinController(backend, $q) {\n\n    var vm = this;\n\n    vm.switchService = switchService;\n    vm.switchServiceItem = switchServiceItem;\n    vm.getInsuranceFullPrice = getInsuranceFullPrice;\n    vm.updateAvailable = updateAvailable;\n    vm.saveIinHandlers = [];\n\n    vm.orderInfo = backend.getOrderInfo();\n\n    updateAvailable();\n\n    function updateAvailable() {\n\n        vm.availableByPassengers = vm.orderInfo.passengers.map(function (passenger, passengerNum) {\n            return (\n                vm.service.itemsByPassengers[passengerNum].length &&\n                passenger.nationalityCode === 'KZ' &&\n                passenger.documentNumberDiscount &&\n                (checkAdult(passenger) || hasAdultKzWithIin())\n            );\n        });\n\n        vm.insuranceAvailable = hasAdultKz() && !hasInternationalFlights();\n    }\n\n    function hasAdultKzWithIin() {\n        return vm.orderInfo.passengers.some(function (passenger) {\n            return (\n                checkAdult(passenger) &&\n                passenger.documentNumberDiscount &&\n                passenger.nationalityCode === 'KZ'\n            );\n        });\n    }\n\n    function hasAdultKz() {\n        return vm.orderInfo.passengers.some(function (passenger) {\n            return (\n                checkAdult(passenger) &&\n                passenger.nationalityCode === 'KZ'\n            );\n        });\n    }\n\n    function hasInternationalFlights() {\n        return  vm.orderInfo.plainFlights.some(function (flight) {\n            var destinationCity = backend.getCityByCode(flight.destinationcity);\n            var originCity = backend.getCityByCode(flight.origincity);\n            return (\n                !destinationCity ||\n                !originCity ||\n                destinationCity.countryEn !== 'KZ' ||\n                originCity.countryEn !== 'KZ'\n            );\n        });\n    }\n\n    function checkAdult(passenger) {\n        var age = moment(backend.sessionParams.todayDate, 'DD.MM.YYYY').diff(\n            moment(passenger.dateOfBirth, 'DD.MM.YYYY'),\n            'years'\n        );\n        return age >= 18;\n    }\n\n    function switchService() {\n        if (!vm.locked) {\n            vm.service.active = !vm.service.active;\n            if (vm.service.active) {\n                if (vm.service.items.length === 1) {\n                    backend.modifyExtraService(getInsuranceSubmitParams(vm.service.items[0]));\n                }\n            } else {\n                backend.removeExtraService({\n                    code: vm.service.onlineMode ? 'insuranceOnline' : 'insurance'\n                });\n            }\n        }\n    }\n\n    function switchServiceItem(itemNum, passengerNum) {\n        if (!vm.locked) {\n            if (vm.orderInfo.passengers[passengerNum].documentNumberDiscount) {\n                backend[\n                    vm.service.itemsByPassengers[passengerNum][itemNum].selected ?\n                        'removeExtraService' :\n                        'modifyExtraService'\n                    ](\n                    getInsuranceSubmitParams(\n                        vm.service.itemsByPassengers[passengerNum][itemNum],\n                        vm.orderInfo.passengers[passengerNum].id\n                    )\n                );\n            } else {\n                if (checkAdult(vm.orderInfo.passengers[passengerNum]) || hasAdultKzWithIin()) {\n                    vm.saveIinHandlers[passengerNum]().then(function () {\n                        switchServiceItem(itemNum, passengerNum);\n                    });\n                } else {\n                    $q.race(vm.saveIinHandlers.filter(function (handler, num) {\n                        return num !== passengerNum;\n                    }).map(function (handler) {\n                        return handler();\n                    })).then(function () {\n                        switchServiceItem(itemNum, passengerNum);\n                    });\n                }\n\n            }\n        }\n    }\n\n    function getInsuranceFullPrice(item) {\n        return {\n            value: item.price || Big(item.insurance_premium || 0).plus(item.luggage_premium || 0).toFixed(2),\n            currency: item.currency\n        };\n    }\n\n    function getInsuranceSubmitParams(item, passenger_id) {\n        var params = {\n            code: 'insurance',\n            ins: item.ins,\n            tins: item.tins,\n            passenger_id: passenger_id\n        };\n        if (vm.service.onlineMode) {\n            params.code = 'insuranceOnline';\n            params.productCode = item.productCode;\n        }\n        return params;\n    }\n\n}\n\n\n},{}],2:[function(require,module,exports){\n\"use strict\";\nalert('hello world');\n},{}],3:[function(require,module,exports){\n\"use strict\";\nrequire('./components/es-insurance/es-insurance');\nrequire('./components/es-insurance-with-iin/es-insurance-with-iin');\n\n},{\"./components/es-insurance-with-iin/es-insurance-with-iin\":1,\"./components/es-insurance/es-insurance\":2}]},{},[3]);\n"]}