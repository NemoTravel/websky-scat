!function(){function e(n,r,i){function t(s,a){if(!r[s]){if(!n[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var d=r[s]={exports:{}};n[s][0].call(d.exports,function(e){var r=n[s][1][e];return t(r||e)},d,d.exports,e,n,r,i)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)t(i[s]);return t}return e}()({1:[function(e,n,r){"use strict";function i(e,n){function r(){d.availableByPassengers=d.orderInfo.passengers.map(function(e,n){return d.service.itemsByPassengers[n].length&&"KZ"===e.nationalityCode&&e.documentNumberDiscount&&(o(e)||i())}),d.insuranceAvailable=t()}function i(){return d.orderInfo.passengers.some(function(e){return o(e)&&e.documentNumberDiscount&&"KZ"===e.nationalityCode})}function t(){return d.orderInfo.passengers.some(function(e){return o(e)&&"KZ"===e.nationalityCode})}function o(n){var r=moment(e.sessionParams.todayDate,"DD.MM.YYYY").diff(moment(n.dateOfBirth,"DD.MM.YYYY"),"years");return r>=18}function s(){d.locked||(d.service.active=!d.service.active,d.service.active?1===d.service.items.length&&e.modifyExtraService(u(d.service.items[0])):e.removeExtraService({code:d.service.onlineMode?"insuranceOnline":"insurance"}))}function a(r,t){var s=u(d.service.itemsByPassengers[t][r],d.orderInfo.passengers[t].id);d.locked||(d.service.itemsByPassengers[t][r].selected?e.removeExtraService(s).then(function(){d.iinFormTouched[t]=!1}):d.orderInfo.passengers[t].documentNumberDiscount?e.modifyExtraService(s):o(d.orderInfo.passengers[t])||i()?d.saveIinHandlers[t]().then(function(){a(r,t)}):n.race(d.saveIinHandlers.filter(function(e,n){return n!==t}).map(function(e){return e()})).then(function(){a(r,t)}))}function c(e){return{value:e.price||Big(e.insurance_premium||0).plus(e.luggage_premium||0).toFixed(2),currency:e.currency}}function u(e,n){var r={code:"insurance",ins:e.ins,tins:e.tins,passenger_id:n};return d.service.onlineMode&&(r.code="insuranceOnline",r.productCode=e.productCode),r}var d=this;d.switchService=s,d.switchServiceItem=a,d.getInsuranceFullPrice=c,d.updateAvailable=r,d.saveIinHandlers=[],d.orderInfo=e.getOrderInfo(),r()}angular.module("app").component("esInsuranceIin",{templateUrl:"components/es-insurance-with-iin/es-insurance-with-iin.html",controller:["backend","$q",i],controllerAs:"vm",bindings:{service:"=service",locked:"=locked",hasOtherServices:"="}})},{}],2:[function(e,n,r){"use strict";angular.module("app").directive("iincheck",["iinUtils","backend",function(e,n){return{require:"ngModel",scope:{pax:"=iincheck"},link:function(r,i,t,o){function s(i){var t=!i||e.isValidIinForPax(i,r.pax.gender,r.pax.dateOfBirth);return o.$setValidity("iincheck",t),t?delete o.$error.customMessage:o.$error.customMessage=n.getAliasDynamic("web.extraServices.insurance.invalidIinMessage"),i}o&&r.pax&&(o.$parsers.unshift(s),o.$formatters.unshift(s))}}}])},{}],3:[function(e,n,r){"use strict";function i(e,n,r,i){function t(){return s.submitTouched=!0,r(function(n,r){!s.loading&&s.iinForm.$valid?s.editableValue!=s.passenger.documentNumberDiscount?(s.loading=!0,e.modifyPassenger({additionalDocumentType:"ИИН",additionalDocumentNumber:s.editableValue,index:s.num}).then(function(){s.loading=!1,s.passenger.documentNumberDiscount=s.editableValue,s.onModify(),n()},function(){s.loading=!1,r()})):n():(s.iinForm.$invalid&&jQuery("form.iinForm__js.ng-invalid",i).triggerHandler("submit"),r())})}function o(e){return e.documentNumberDiscount?e.documentNumberDiscount:n.getIinStart(e.dateOfBirth,e.gender)}var s=this;s.saveIin=t,s.editableValue=o(s.passenger),s.$onInit=function(){n.addSaveIinHander(s.saveIin,s.num)}}angular.module("app").component("passengerIinForm",{templateUrl:"components/passenger-iin-form/passenger-iin-form.html",controller:["backend","iinUtils","$q","$element",i],controllerAs:"vm",bindings:{passenger:"=passenger",num:"=num",onModify:"&",submitTouched:"=touched",saveIin:"=?"}})},{}],4:[function(e,n,r){"use strict";e("./components/es-insurance-with-iin/es-insurance-with-iin"),e("./components/passenger-iin-form/passenger-iin-form"),e("./components/iincheck/iincheck"),e("./services/iinUtils"),e("./screens/booking/BookingScreenController")},{"./components/es-insurance-with-iin/es-insurance-with-iin":1,"./components/iincheck/iincheck":2,"./components/passenger-iin-form/passenger-iin-form":3,"./screens/booking/BookingScreenController":5,"./services/iinUtils":6}],5:[function(e,n,r){"use strict";angular.module("app").controller("BookingScreenController",["$scope","fancyboxTools","backend","utils","redirect","iinUtils","$q",function(e,n,r,i,t,o,s){function a(){var e;!f.agree||f.modifyServicesLoading||f.orderServicesLoading||(f.selectedPaymentForm&&f.selectedPaymentType?(e=_.findWhere(f.priceVariant,{code:f.selectedPaymentForm}),e.conflicts_with_aeroexpress||e.conflicts_with_insurance?n.openHandler("popupCancelConflictServices",!1,{paymentForm:f.selectedPaymentForm,aeroexpress:e.conflicts_with_aeroexpress,insurance:e.conflicts_with_insurance,submitCallback:c}):s.all(o.getSaveIinHanders().filter(function(e,n){return f.orderInfo&&f.orderInfo.groupedEditableExtraServices&&f.orderInfo.groupedEditableExtraServices.insurance&&!!f.orderInfo.groupedEditableExtraServices.insurance[n]}).map(function(e){return e()})).then(function(){c()})):f.showNeedSelectPaymentFormMesage=!0)}function c(e){f.doBookingAndRegisterOrderLoading=!0,f.bookingError&&delete f.bookingError,r.doBookingAndRegisterOrder(f.selectedPaymentForm,f.selectedPaymentType,e,f.card).then(function(e){e.pnr&&e.lastName?t.goToConfirmOrder():(e.eraseAeroexpressBecauseOfCurrency||e.eraseInsuranceBecauseOfCurrency)&&n.openHandler("popupChangeCurrencyError",!1,{eraseAeroexpressBecauseOfCurrency:e.eraseAeroexpressBecauseOfCurrency,eraseInsuranceBecauseOfCurrency:e.eraseInsuranceBecauseOfCurrency,mode:"booking",submitCallback:c}),f.doBookingAndRegisterOrderLoading=!1},function(e){f.doBookingAndRegisterOrderLoading=!1,f.bookingError=e.error})}function u(e){f.showNeedSelectPaymentFormMesage=!1,r.changePaymentForm(e)}function d(){f.submitButtonHover=!f.submitButtonHover}const f=this;f.loading=!0,f.orderServicesLoading=!0,f.submitPayment=a,f.paymentFormChangeHandler=u,f.swithcSubmitButtonHoverState=d,e.$on("plasticCardForPaymentChangeEvent",function(e,n){f.card=n}),r.ready.then(function(){angular.element("title").text(r.getAliasWithPrefix("web.pageTitle.","extraServices")),r.clearOrderInfoListeners(),r.clearUpdateOrderServicesListeners(),r.addOrderInfoListener(function(e){return e&&e.header&&e.header.regnum&&e.passengers&&e.passengers[0]&&e.passengers[0].lastName?(f.loading=!0,void t.goToConfirmOrder()):void(f.orderInfo=e)}),r.addUpdateOrderServicesListener(function(e){f.orderInfo=e[1],f.priceVariant=e[2],f.isFreePricevariant=i.isFreePricevariant(e[2]),f.es=i.reformatAvailableExtraServices(e[0],f.orderInfo,f.es),f.esList=i.getAvailableExtraServicesList(e[0],f.es),f.loading=!1,f.orderServicesLoading=!1,r.getParam("ffp.enable")&&(f.orderInfo.hasBonusCard||f.orderInfo.ffpSumm)&&r.ffpBonus().then(function(e){f.ffpBonus=e.total||0})},function(e){f.loading=!1,f.orderServicesLoading=!1,f.errorMessage=e.error}),r.updateOrderServices(!0).then(function(){r.switchDefaultSelectedServices(f.esList,f.es,f.orderInfo)}),r.addExtraServiceListener(function(e){f.modifyServicesLoading=!e,f.orderServicesLoading=!0}),r.addExtraServiceErrorListener(function(e,n){n&&"seat"===n.code||(f.modifyServicesError=e.error),f.modifyServicesLoading=!1,f.orderServicesLoading=!0})})}])},{}],6:[function(e,n,r){"use strict";angular.module("app").factory("iinUtils",[function(){function e(e,r){var i=moment(e,"DD.MM.YYYY");return i.format("YYMMDD")+n(i,r)}function n(e,n){var i=r(e.year());if("male"===n){if(19===i)return"1";if(20===i)return"3";if(21===i)return"5"}else if("female"===n){if(19===i)return"2";if(20===i)return"4";if(21===i)return"6"}return""}function r(e){var n=e-1;return Math.floor(n/100)+1}function i(e){var n,r,i;return e&&11===e.length&&(n=e.split(""),r=[1,2,3,4,5,6,7,8,9,10,11],i=s(n,r)%11,10===i&&(r=[3,4,5,6,7,8,9,10,11,1,2],i=s(n,r)%11),i>=0&&9>=i)?i:-1}function t(e){return e&&12===e.length&&moment(e.substr(0,6),"YYMMDD").isValid()&&i(e.substr(0,11))==e[11]?!0:!1}function o(n,r,i){return n.substr(0,7)===e(i,r)&&t(n)}function s(e,n){var r=0;if(e&&n&&e.length===n.length){for(var i=0;i<e.length;i++)r+=e[i]*n[i];return r}}function a(e,n){u[n]=e}function c(){return u}var u=[];return{getIinStart:e,getIinCenturyGenderCode:n,getCenturyByYear:r,getIinCheckSumm:i,isValidIin:t,isValidIinForPax:o,addSaveIinHander:a,getSaveIinHanders:c}}])},{}]},{},[4]);
//# sourceMappingURL=custom-controllers.js.map
